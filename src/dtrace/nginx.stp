/* tapset for nginx */

/* retrieve the request uri string from the ngx_http_request_t pointer */
function ngx_http_req_uri(r)
{
    len = @cast(r, "ngx_http_request_s", "NGX_SBIN_PATH")->uri->len

    if (len == 0) {
        return ""
    }

    return user_string_n(@cast(r, "ngx_http_request_s", "NGX_SBIN_PATH")->uri->data, len)
}


/* retrieve the request query string from the ngx_http_request_t pointer */
function ngx_http_req_args(r)
{
    len = @cast(r, "ngx_http_request_s", "NGX_SBIN_PATH")->args->len

    if (len == 0) {
        return ""
    }

    return user_string_n(@cast(r, "ngx_http_request_s", "NGX_SBIN_PATH")->args->data, len)
}


/* retrieve the first command name (or directive name) from
 * the ngx_module_t pointer */
function ngx_http_module_cmd(m)
{
    cmds = @cast(m, "ngx_module_t", "NGX_SBIN_PATH")->commands
    if (cmds == 0) {
        return ""
    }

    len = @cast(cmds, "ngx_command_t", "NGX_SBIN_PATH")->name->len

    if (len == 0) {
        return ""
    }

    return user_string_n(@cast(cmds, "ngx_command_t", "NGX_SBIN_PATH")->name->data, len)
}


function ngx_chain_buf(cl)
{
    return @cast(cl, "ngx_chain_t", "NGX_SBIN_PATH")->buf
}


function ngx_buf_in_memory(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->temporary
        || @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->memory
        || @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->mmap
}


function ngx_buf_pos(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->pos
}


function ngx_buf_file_pos(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->file_pos
}


function ngx_buf_last(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->last
}


function ngx_buf_file_last(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->file_last
}


function ngx_buf_end(b)
{
    return @cast(b, "ngx_buf_t", "NGX_SBIN_PATH")->end
}


function ngx_buf_size(b)
{
    if (ngx_buf_in_memory(b)) {
        return ngx_buf_last(b) - ngx_buf_pos(b)
    }

    return ngx_buf_file_last(b) - ngx_buf_file_pos(b)
}


function ngx_buf_data(b)
{
    return user_string_n(ngx_buf_pos(b), ngx_buf_last(b) - ngx_buf_pos(b))
}


function ngx_pool_cleanup_file_name(c)
{
    return user_string(@cast(c, "ngx_pool_cleanup_file_t", "NGX_SBIN_PATH")->name)
}


function ngx_http_req_content_length(r)
{
    return @cast(r, "ngx_http_request_t", "NGX_SBIN_PATH")->headers_in->content_length_n
}


function ngx_http_req_body_temp_file_name(r)
{
    rb = @cast(r, "ngx_http_request_t", "NGX_SBIN_PATH")->request_body
    if (!rb) {
        return ""
    }

    tf = @cast(rb, "ngx_http_request_body_t", "NGX_SBIN_PATH")->temp_file
    if (!tf) {
        return ""
    }

    len = @cast(tf, "ngx_temp_file_t", "NGX_SBIN_PATH")->file->name->len

    return user_string_n(@cast(tf, "ngx_temp_file_t", "NGX_SBIN_PATH")->file->name->data, len)
}


function ngx_table_elt_key(e)
{
    len = @cast(e, "ngx_table_elt_t", "NGX_SBIN_PATH")->key->len

    return user_string_n(@cast(e, "ngx_table_elt_t", "NGX_SBIN_PATH")->key->data, len)
}


function ngx_table_elt_value(e)
{
    len = @cast(e, "ngx_table_elt_t", "NGX_SBIN_PATH")->value->len

    return user_string_n(@cast(e, "ngx_table_elt_t", "NGX_SBIN_PATH")->value->data, len)
}

